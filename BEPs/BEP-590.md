<pre>
  BEP: 590
  Title: Extended Voting Rules for Fast Finality Stability
  Status: Draft
  Type: Standards
  Created: 2025-06-25
  Description: Enhance the robustness of Fast Finality by extending aggregate vote inclusion rules.
</pre>

# BEP-590: Extended Voting Rules for Fast Finality Stability

- [BEP-590: Extended Voting Rules for Fast Finality Stability](#bep-590-extended-voting-rules-for-fast-finality-stability)
	- [1. Summary](#1-summary)
	- [2. Abstract](#2-abstract)
	- [3. Motivation](#3-motivation)
	- [4. Specification](#4-specification)
		- [4.1 Validator Vote Rule 3 Changes](#41-validator-vote-rule-3-changes)
		- [4.2 Aggregate Vote Rule Changes](#42-aggregate-vote-rule-changes)
	- [5. Security](#5-security)
	- [6. Liveness](#6-liveness)
	- [7. Backward Compatibility](#7-backward-compatibility)
	- [8. License](#8-license)

## 1. Summary

This BEP proposes coordinated extensions to both the validator voting logic and aggregate vote inclusion rules in the Fast Finality (FF) protocol of the BNB Smart Chain. These changes aim to improve the stability and liveness of Fast Finality under adverse network conditions and support further reductions in block interval.

## 2. Abstract

[BEP-126](./BEP126.md) introduced Fast Finality as a mechanism for deterministic block finalization in BNB Smart Chain. Under the original design:

* Validators always vote for the latest block.
* Proposers (miners) may only aggregate votes for their direct parent block.

Formally, if `KAncestorGenerationDepth` defines the inclusion scope, then in the original design:

```
KAncestorGenerationDepth = 1
```

This BEP extends the scope by allowing `KAncestorGenerationDepth > 1`:

1. **Validator Voting Rule Extension** — Validators may vote for blocks up to `KAncestorGenerationDepth` blocks counting from (and including) the current chain head, using the latest justified block as the vote source. This helps sustain finalization progress even when vote propagation or inclusion is delayed.
   
2. **Aggregate Vote Inclusion Extension** — Proposers may include votes for up to `KAncestorGenerationDepth` recent ancestor blocks, improving tolerance to vote propagation latency.

Together, these adjustments enhance the resilience of Fast Finality during periods of network congestion, without modifying the core consensus model or cryptographic assumptions.

## 3. Motivation

Validators can experience latency in receiving, verifying, and casting votes for blocks. Such delays may lead to missing justifications, which in turn hinders finalization.

Additionally, as block intervals shorten, inter-region network latency becomes a more prominent bottleneck in vote propagation.

This BEP addresses these issues by introducing:

* **Smarter validator voting logic** — to sustain finalization progress even when votes are not timely arrived.
* **More flexible vote aggregation** — to increase the chances of including valid votes despite network delays.

## 4. Specification

This BEP introduces coordinated modifications to:

* **Validator Vote Rules** (Section 4.1)
* **Aggregate Vote Inclusion Rules** (Section 4.2)

### 4.1 Validator Vote Rule 3 Changes

To maintain finalization even when vote inclusion is delayed, we revise `Validator Vote Rule 3` from [BEP-126](./BEP126.md) as follows:

**Rule 1 — Skip voting**

The validator **skips voting** if all of the following conditions are met:

* `curHead` has no attestation
* the **parent block (`parent`) has an attestation**, but **its attestation does not justify the grandparent block**
  
**Rule 2 — Vote for `latestJustified + 1`**

The validator **votes for the block at `latestJustified + 1`** if all of the following conditions are met:

* voting for the block at `latestJustified + 1` has been skipped previously
* `curHead` has an attestation **but does not advance the finalized height**
* voting for the block at `latestJustified + 1` is **expected to be aggregatable**

**Rule 3 — Vote for `curHead` (Fallback)**

* If neither **Rule 1** nor **Rule 2** applies, the validator **votes for the current block (`curHead`)**.

This algorithm defaults to voting for the **latest chain head**, ensuring steady progress while preserving safety:

* **Vote discipline** — Rule 1 suppresses redundant votes, enabling Rule 2 to operate without violating the “one vote per height” rule.
* **Finalized growth** — Rule 2 advances the finalized height by voting for `latestJustified + 1` when intermediate blocks have be skipped.
* **Head preference** — Rule 3 prioritize voting for the head to prevent inactivity and maintain liveness.

It is also evident that this algorithm ensures the **voter target number is monotonically increasing**.
Together, these rules balance rapid justification of the head with consistent finalized height growth, improving robustness under network delays.

For example, if votes produced after verifying block N arrive during the sealing of block N+2, voting and justification progress can continue as follows:

| Block Mined | Aggregated Votes | Validator Vote (Post Verify) | Latest Justified | Latest Finalized | Rule Triggered |
|-------------|------------------|-------------------------------|------------------|------------------|-----------------|
| 4           | -                | 0 → 4                         | 0                | 0                | Rule 3          |
| 5           | -                | 0 → 5                         | 0                | 0                | Rule 3          |
| 6           | 0 → 4            | 4 → 6                         | 4                | 0                | Rule 3          |
| 7           | -                | skip                          | 4                | 0                | Rule 1          |
| 8           | 4 → 6            | 6 → 7                         | 6                | 0                | Rule 2          |
| 9           | -                | skip                          | 6                | 4                | Rule 1          |
| 10          | 6 → 7            | 7 → 10                        | 7                | 6                | Rule 3          |
| 11          | -                | skip                          | 7                | 6                | Rule 1          |
| 12          | 7 → 10           | 10 → 11                       | 10               | 6                | Rule 2          |
| 13          | -                | skip                          | 10               | 6                | Rule 1          |
| 14          | 10 → 11          | 11 → 14                       | 11               | 10               | Rule 3          |


### 4.2 Aggregate Vote Rule Changes

To improve vote inclusion under delayed network conditions, proposers are allowed to aggregate votes for recent ancestor blocks. The process follows this priority sequence:

1. Attempt to aggregate votes for the **immediate parent block**.
2. If unavailable, try the **grandparent block**.
3. Continue iteratively up to `KAncestorGenerationDepth` recent ancestors.

The process **terminates immediately** once any valid vote is included. At most **one ancestor block’s votes** may be aggregated in a single proposal.

This rule gives validators up to `KAncestorGenerationDepth` block intervals to propagate their votes, improving the success rate of vote inclusion and reducing justification gaps during periods of network latency.

With [the block interval reduced to 0.45s](./BEP-619.md), the parameter `KAncestorGenerationDepth` is set to 3.
```
  KAncestorGenerationDepth = 3
```

## 5. Security

This BEP does **not** alter the core safety assumptions or mechanisms of Fast Finality defined in [BEP-126](./BEP126.md). Specifically, it **does not change**:

* **Validator Vote Rules** — which govern when and how validators may issue votes.
* **Finality Rules** — including thresholds for justification and finalization.
* **Longest Chain Rule** — the fork-choice rule determining canonical chain selection.

This proposal only modifies:

* **Validator Vote Rule 3** — to improve finalization liveness.
* **Vote aggregation scope** — to improve vote inclusion flexibility.
  
All original safety guarantees, including one-block finality under an honest super majority, remain **intact**.

## 6. Liveness

Assume that a vote generated upon receiving block **N** can only be received by other validators when block **N + D** is produced. We refer to **D** as the **vote propagation delay**.

* When the block interval is large, typically **D = 1**:

  * A block requires **1 subsequent block** to become justified.
  * And **2 subsequent blocks** to become finalized.

* As the block interval decreases or the GasLimit increases, **D** grows. Votes alternate between **justifying the latest head** and **advancing the finalized height**.

| Metric                 | Lag behind latest head (blocks) | Average    |
| ---------------------- | ------------------------------- | ---------- |
| Justified block number | `[D ... 2D-1, 2D-1 ... 3D-2]`   | `2D-1`     |
| Finalized block number | `[2D ... 4D-1]`                 | `3D - 1/2` |

Additionally, to ensure continuous growth of the finalized block number:

```
KAncestorGenerationDepth + 1 ≥ 2D
```

## 7. Backward Compatibility

This BEP is **not backward compatible** with older clients, as it changes vote aggregation behavior. However, it introduces no changes to protocol-level message formats or user-facing APIs.

A full client upgrade across validators and block producers is required to activate the changes and maintain consensus.

## 8. License

The content is licensed under [Creative Commons CC0 1.0 Universal License](https://creativecommons.org/publicdomain/zero/1.0/).