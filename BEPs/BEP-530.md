<pre>
  BEP: 530
  Title: Improved Block Producer Selection Mechanism
  Status: Draft
  Type: Standards
  Created: 2025-02-28
  Description: A comprehensive block producer selection mechanism designed to enhance security, fairness, robustness, and simplicity.
</pre>

- [BEP-530: Improved Block Producer Selection Mechanism](#bep-530-improved-block-producer-selection-mechanism)
  - [1. Summary](#1-summary)
  - [2. Abstract](#2-abstract)
  - [3. Motivation](#3-motivation)
  - [4. Specification](#4-specification)
    - [4.1 Algorithm Overview](#41-algorithm-overview)
      - [4.1.1 Validator Set Retrieval](#411-validator-set-retrieval)
      - [4.1.2 Determining Turn Order](#412-determining-turn-order)
      - [4.1.3 Producer Filtering](#413-producer-filtering)
    - [4.2 Algorithm Evaluation](#42-algorithm-evaluation)
      - [4.2.1 Security Analysis](#421-security-analysis)
      - [4.2.2 Fairness Assessment](#422-fairness-assessment)
      - [4.2.3 Robustness Evaluation](#423-robustness-evaluation)
      - [4.2.4 Simplicity Analysis](#424-simplicity-analysis)
  - [5. Backwards Compatibility](#5-backwards-compatibility)
  - [6. License](#6-license)

# BEP-530: Improved Block Producer Selection Mechanism

## 1. Summary
This BEP proposes an improved block producer selection mechanism.

## 2. Abstract
This BEP introduces a new algorithm for selecting block producers, offering improvements in four key areas: security, fairness, robustness, and simplicity.

## 3. Motivation
The motivation is to increase the ratio of blocks produced by the "in-turn" validator to enhance network stability. Additionally, it aims to improve the predictability of backup validators at each block height to support optimized transaction and block propagation.

## 4. Specification
### 4.1 Algorithm Overview
#### 4.1.1 Validator Set Retrieval
Each epoch involves a change in the validator set. After retrieving the new set from the contract, we use `epochNumber (blockNumber / EpochLength)` as the seed to randomly shuffle the validator set. Validators are assigned an index within the range `[0, len(validators))`, and this index remains unchanged for the duration of the epoch.

#### 4.1.2 Determining Turn Order
At any given block height, one validator is designated as the "in-turn" validator with the highest priority to produce a block, with a block difficulty of 2. Additionally, multiple backup validators are assigned with a block difficulty of 1, and their blocks are broadcasted with a delay. The index of the in-turn validator at block height     `blockNumber` is determined as follows:
```Go
// turnLength specifies how many consecutive blocks a validator can produce
inturnIndex := blockNumber / uint64(turnLength) % uint64(len(validators))
```

Backup validators are selected by reversing the order of the validators prior to the `inturnIndex`. The block producer sequence, including both in-turn and backup validators, is shown as follows:
```Go
// Reverse round	
for order := 0; order < len(validators); order++ {
			log.Debug("block producing", "order", order,
				"validator index", (inturnIndex+len(validators)-order)%len(validators))
}
```

#### 4.1.3 Producer Filtering
To prevent chain splits, Parlia continuously records the recent block producers within a given length, known as `MinerHistory`. Once these validators reach a predefined block production threshold, they are no longer eligible to produce blocks at the current height. This BEP proposes using the latest finalized block to clean `MinerHistory`, removing producers who have produced blocks up to and including the latest finalized block.

By filtering out validators who are ineligible to produce blocks at the current height based on `MinerHistory`, the algorithm obtains the list of allowed validators and their production sequence for the current height.

### 4.2 Algorithm Evaluation
#### 4.2.1 Security Analysis
The existing algorithm introduces randomness only in the sorting of backup validators. However, adjacent "in-turn" validators may potentially collude, as could the "in-turn" validator and the first backup validator at the same block height. This BEP mitigates the risk of collusion by introducing randomness in the retrieval of the validator set. 

Additionally, `MinerHistory` is still used to filter out validators that are ineligible to produce blocks, preventing chain splits.

#### 4.2.2 Fairness Assessment
In the current algorithm, the validator set is ordered by address, which may result in certain addresses having more block production rights. This BEP randomizes the order of the validator set, ensuring a fairer distribution of block production rights among validators.

#### 4.2.3 Robustness Evaluation
The robustness in this context refers to whether validators can produce blocks in their designated turn when some nodes are malfunctioning.

This BEP clears the MinerHistory based on the latest finalized block, which reduces the likelihood of the in-turn validator being filtered out by MinerHistory when Fast Finality is functioning correctly.

When Fast Finality is not working properly, the new algorithm ensures that validators about to be in-turn are not prioritized as backup validators at the current block height, further reducing the chance of them being excluded by `MinerHistory` during their in-turn block production.

In summary, this algorithm increases the likelihood of blocks being produced by the in-turn validator.

#### 4.2.4 Simplicity Analysis
The logic for selecting the in-turn validator remains unchanged, but the logic for selecting backup validators has been simplified. Particularly when Fast Finality is functioning properly, the sequence of block producers can be roughly viewed as validators being selected in reverse order from the `inturnIndex`.

## 5. Backwards Compatibility
A hard fork is required to implement this mechanism.

## 6. License
The content is licensed under [CC0](https://creativecommons.org/publicdomain/zero/1.0/).