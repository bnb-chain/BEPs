<pre>
  BEP: 530
  Title: Improved Block Producer Selection Mechanism
  Status: Draft
  Type: Standards
  Created: 2025-02-28
  Description: A comprehensive block producer selection mechanism designed to enhance security, fairness, robustness, and simplicity.
</pre>

- [BEP-530: Improved Block Producer Selection Mechanism](#bep-530-improved-block-producer-selection-mechanism)
  - [1. Summary](#1-summary)
  - [2. Abstract](#2-abstract)
  - [3. Motivation](#3-motivation)
  - [4. Specification](#4-specification)
    - [4.1 Validator Set Retrieval](#41-validator-set-retrieval)
    - [4.2 Determining Turn Order](#42-determining-turn-order)
    - [4.3 Producer Filtering](#43-producer-filtering)
  - [5. Rationale](#5-rationale)
    - [5.1 Robustness Evaluation](#51-robustness-evaluation)
    - [5.2 Simplicity Analysis](#52-simplicity-analysis)
  - [6. Backwards Compatibility](#6-backwards-compatibility)
  - [7. License](#7-license)

# BEP-530: Improved Block Producer Selection Mechanism

## 1. Summary
This BEP proposes an improved block producer selection mechanism.

## 2. Abstract
This BEP introduces a new algorithm for selecting block producers, aimed at improving robustness and simplicity..

## 3. Motivation
The motivation is to increase the ratio of blocks produced by the "in-turn" validator to enhance network stability. Additionally, it aims to improve the predictability of backup validators at each block height to support optimized transaction and block propagation.

## 4. Specification
The algorithm consists of 3 steps, which will be detailed below.

### 4.1 Validator Set Retrieval
Each epoch introduces a change in the validator set. Upon retrieving the new set from the contract, the validators are ordered by address and assigned an index in the range `[0, len(validators))`. This index remains fixed throughout the epoch.

### 4.2 Determining Turn Order
At any given block height, one validator is designated as the "in-turn" validator with the highest priority to produce a block, with a block difficulty of 2. Additionally, multiple backup validators are assigned with a block difficulty of 1, and their blocks are broadcasted with a delay. The index of the in-turn validator at block height `blockNumber` is determined as follows:
```Go
// turnLength specifies how many consecutive blocks a validator can produce
inturnIndex := blockNumber / uint64(turnLength) % uint64(len(validators))
```

Backup validators are selected by reversing the order of the validators prior to the `inturnIndex`. 
<div align="center">
<img src=./assets/BEP-530/4-2.png width=50% />
</div>

Example: The validator set consists of five validators indexed from [0,4], named V0, V1, V2, V3, and V4. Assuming the in-turn validator at the current height is V1, the backup validators are ordered as follows: V0, V4, V3, V2.

### 4.3 Producer Filtering
To prevent chain splits, Parlia continuously records the recent block producers within a given length, known as `MinerHistory`. Once these validators reach a predefined block production threshold, they are no longer eligible to produce blocks at the current height. This BEP proposes using the latest finalized block to clean `MinerHistory`, removing producers who have produced blocks up to and including the latest finalized block.

By filtering out validators who are ineligible to produce blocks at the current height based on `MinerHistory`, the algorithm obtains the list of allowed validators and their production sequence for the current height.

## 5. Rationale
The rationale will be assessed based on 4 aspects: security, fairness, robustness, and simplicity.

### 5.1 Robustness Evaluation
The robustness in this context refers to whether validators can produce blocks in their designated turn when some nodes are malfunctioning.

This BEP clears the MinerHistory based on the latest finalized block, which reduces the likelihood of the in-turn validator being filtered out by MinerHistory when Fast Finality is functioning correctly.

When Fast Finality is not working properly, the new algorithm ensures that validators about to be in-turn are not prioritized as backup validators at the current block height, further reducing the chance of them being excluded by `MinerHistory` during their in-turn block production.

In summary, this algorithm increases the likelihood of blocks being produced by the in-turn validator.

### 5.2 Simplicity Analysis
The logic for selecting the in-turn validator remains unchanged, but the logic for selecting backup validators has been simplified. Particularly when Fast Finality is functioning properly, the sequence of block producers can be roughly viewed as validators being selected in reverse order from the `inturnIndex`.

## 6. Backwards Compatibility
The new mechanism randomizes the order of the validator set before selection, reducing the risk of collusion and malicious behavior while ensuring a more equitable distribution of block production rights among validators.

## 7. License
The content is licensed under [CC0](https://creativecommons.org/publicdomain/zero/1.0/).